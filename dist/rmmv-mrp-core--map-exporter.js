//=============================================================================
// RPG Maker MV MRP Map Exporter
// rmmv-mrp-core--map-exporter.js
// Version: 0.0.18
//=============================================================================

//=============================================================================
/*:
 * @plugindesc Export the entire current game map as a PNG file.
 * @author Mark Przepiora
 *
 * @help
 * ============================================================================
 * Instructions
 * ============================================================================
 *
 * Simply run,
 *
 *     MRP.MapExporter();
 *
 * from a JavaScript console or an event. A PNG file named map.png will be
 * downloaded to your computer containing the entire map, including events, but
 * not including your character.
 *
 * Should work just fine with custom tile sizes and resolutions, but that is
 * untested.
 *
 * This function is part of the rmmv-mrp-core library, but this file
 * (rmmv-mrp-core--map-exporter.js) is a standalone bundle containing only the
 * MapExporter. If you are interested in using the rest of the utilities in
 * rmmv-mrp-core, then you should instead add the rmmv-mrp-core.js bundle as a
 * plugin, as that file includes this and all the other core modules.
 *
 * Please look on GitHub for complete instructions:
 * https://github.com/markprzepiora/rmmv-mrp-core/blob/master/docs/MapExporter.md
 */
//=============================================================================

!function(t){var n={};function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:r})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var o in t)e.d(r,o,function(n){return t[n]}.bind(null,o));return r},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=31)}([function(t,n,e){"use strict";var r=e(2);const o={TILE_WIDTH_PX:null,TILE_HEIGHT_PX:null,SCREEN_WIDTH_PX:null,SCREEN_HEIGHT_PX:null,SCREEN_WIDTH_TILES:null,SCREEN_HEIGHT_TILES:null,MAP_WIDTH_TILES:null,MAP_HEIGHT_TILES:null,MAP_WIDTH_PX:null,MAP_HEIGHT_PX:null,MAP_WIDTH_PAGES:null,MAP_HEIGHT_PAGES:null};r.a.on("game.start",function(){o.SCREEN_WIDTH_PX=SceneManager._screenWidth,o.SCREEN_HEIGHT_PX=SceneManager._screenHeight}),r.a.on("map.setup",function(){o.TILE_WIDTH_PX=$gameMap.tileWidth(),o.TILE_HEIGHT_PX=$gameMap.tileHeight(),o.SCREEN_WIDTH_TILES=Math.floor(o.SCREEN_WIDTH_PX/o.TILE_WIDTH_PX),o.SCREEN_HEIGHT_TILES=Math.floor(o.SCREEN_HEIGHT_PX/o.TILE_HEIGHT_PX),o.MAP_WIDTH_TILES=$dataMap.width,o.MAP_HEIGHT_TILES=$dataMap.height,o.MAP_WIDTH_PX=o.MAP_WIDTH_TILES*o.TILE_WIDTH_PX,o.MAP_HEIGHT_PX=o.MAP_HEIGHT_TILES*o.TILE_HEIGHT_PX,o.MAP_WIDTH_PAGES=Math.ceil(o.MAP_WIDTH_PX/o.SCREEN_WIDTH_PX),o.MAP_HEIGHT_PAGES=Math.ceil(o.MAP_HEIGHT_PX/o.SCREEN_HEIGHT_PX)}),n.a=o},function(t,n,e){"use strict";e.r(n),e.d(n,"events",function(){return i}),e.d(n,"event",function(){return a}),e.d(n,"info",function(){return u});var r=e(6),o=e.n(r);function i(t=(()=>!0)){return $gameMap.events().map(t=>c(t.eventId())).filter(t)}function a(t){return"number"==typeof t?c(t):function(t){const n=o()(n=>n&&n.name===t,$dataMap.events);if(n<0)throw`could not find event with name ${t}`;return c(n)}(t)}function u(){return $dataMapInfos[$gameMap.mapId()]}function c(t){const n=$dataMap.events[t],e=$gameMap._events[t];if(!n)throw`could not find event definition with id ${t}`;if(!e)throw`could not find event instance with id ${t}`;return{definition:n,instance:e,id:t}}},function(t,n,e){"use strict";var r=e(5),o=e.n(r),i=e(1);const a=o()({});function u(t,n,e){const r=t.prototype[n];t.prototype[n]=function(){return e(r.bind(this),...arguments)}}function c(t,n,e){const r=t[n];t[n]=function(){return e(r.bind(t),...arguments)}}function l(t,n,e,r){t(n,e,function(t,...n){a.emit(r+".before"),t(...n),a.emit(r+".after"),a.emit(r)})}function f(t,n,e){l(u,t,n,e)}function s(t,n,e){l(c,t,n,e)}f(Game_Troop,"onBattleStart","battle.start"),f(Game_Troop,"onBattleEnd","battle.end"),f(Game_Map,"setup","map.setup"),s(BattleManager,"endTurn","turn.end"),s(BattleManager,"startTurn","turn.start"),s(BattleManager,"startAction","battleAction.start"),s(BattleManager,"endAction","battleAction.end"),s(SceneManager,"run","game.start"),f(Game_Player,"executeMove","player.move"),a.onMap=function(t,n){return a.on("map.setup",function(){i.info().id!==t&&i.info().name!==t||n()}),function(){a.off(observer)}},a.onRegion=function(t,n){return a.on("player.move",function(){$gamePlayer.regionId()===t&&n()}),function(){a.off(observer)}},n.a=a},function(t,n,e){"use strict";var r=e(14)();t.exports=function(t){return t!==r&&null!==t}},function(t,n,e){var r=e(22);t.exports=function(t){return function n(e,o){var i=arguments.length;return 0===i?n:1===i&&null!=e&&!0===e["@@functional/placeholder"]?n:1===i?r(function(n){return t(e,n)}):2===i&&null!=e&&!0===e["@@functional/placeholder"]&&null!=o&&!0===o["@@functional/placeholder"]?n:2===i&&null!=e&&!0===e["@@functional/placeholder"]?r(function(n){return t(n,o)}):2===i&&null!=o&&!0===o["@@functional/placeholder"]?r(function(n){return t(e,n)}):t(e,o)}}},function(t,n,e){"use strict";var r,o,i,a,u,c,l,f=e(7),s=e(21),p=Function.prototype.apply,_=Function.prototype.call,d=Object.create,h=Object.defineProperty,E=Object.defineProperties,g=Object.prototype.hasOwnProperty,I={configurable:!0,enumerable:!1,writable:!0};o=function(t,n){var e,o;return s(n),o=this,r.call(this,t,e=function(){i.call(o,t,e),p.call(n,this,arguments)}),e.__eeOnceListener__=n,this},u={on:r=function(t,n){var e;return s(n),g.call(this,"__ee__")?e=this.__ee__:(e=I.value=d(null),h(this,"__ee__",I),I.value=null),e[t]?"object"==typeof e[t]?e[t].push(n):e[t]=[e[t],n]:e[t]=n,this},once:o,off:i=function(t,n){var e,r,o,i;if(s(n),!g.call(this,"__ee__"))return this;if(!(e=this.__ee__)[t])return this;if("object"==typeof(r=e[t]))for(i=0;o=r[i];++i)o!==n&&o.__eeOnceListener__!==n||(2===r.length?e[t]=r[i?0:1]:r.splice(i,1));else r!==n&&r.__eeOnceListener__!==n||delete e[t];return this},emit:a=function(t){var n,e,r,o,i;if(g.call(this,"__ee__")&&(o=this.__ee__[t]))if("object"==typeof o){for(e=arguments.length,i=new Array(e-1),n=1;n<e;++n)i[n-1]=arguments[n];for(o=o.slice(),n=0;r=o[n];++n)p.call(r,this,i)}else switch(arguments.length){case 1:_.call(o,this);break;case 2:_.call(o,this,arguments[1]);break;case 3:_.call(o,this,arguments[1],arguments[2]);break;default:for(e=arguments.length,i=new Array(e-1),n=1;n<e;++n)i[n-1]=arguments[n];p.call(o,this,i)}}},c={on:f(r),once:f(o),off:f(i),emit:f(a)},l=E({},c),t.exports=n=function(t){return null==t?d(l):E(Object(t),c)},n.methods=u},function(t,n,e){var r=e(4),o=e(23),i=e(27);t.exports=r(o("findIndex",i,function(t,n){for(var e=0,r=n.length;e<r;){if(t(n[e]))return e;e+=1}return-1}))},function(t,n,e){"use strict";var r=e(8),o=e(16),i=e(17),a=e(18);(t.exports=function(t,n){var e,i,u,c,l;return arguments.length<2||"string"!=typeof t?(c=n,n=t,t=null):c=arguments[2],null==t?(e=u=!0,i=!1):(e=a.call(t,"c"),i=a.call(t,"e"),u=a.call(t,"w")),l={value:n,configurable:e,enumerable:i,writable:u},c?r(o(c),l):l}).gs=function(t,n,e){var u,c,l,f;return"string"!=typeof t?(l=e,e=n,n=t,t=null):l=arguments[3],null==n?n=void 0:i(n)?null==e?e=void 0:i(e)||(l=e,e=void 0):(l=n,n=e=void 0),null==t?(u=!0,c=!1):(u=a.call(t,"c"),c=a.call(t,"e")),f={get:n,set:e,configurable:u,enumerable:c},l?r(o(l),f):f}},function(t,n,e){"use strict";t.exports=e(9)()?Object.assign:e(10)},function(t,n,e){"use strict";t.exports=function(){var t,n=Object.assign;return"function"==typeof n&&(n(t={foo:"raz"},{bar:"dwa"},{trzy:"trzy"}),t.foo+t.bar+t.trzy==="razdwatrzy")}},function(t,n,e){"use strict";var r=e(11),o=e(15),i=Math.max;t.exports=function(t,n){var e,a,u,c=i(arguments.length,2);for(t=Object(o(t)),u=function(r){try{t[r]=n[r]}catch(t){e||(e=t)}},a=1;a<c;++a)n=arguments[a],r(n).forEach(u);if(void 0!==e)throw e;return t}},function(t,n,e){"use strict";t.exports=e(12)()?Object.keys:e(13)},function(t,n,e){"use strict";t.exports=function(){try{return Object.keys("primitive"),!0}catch(t){return!1}}},function(t,n,e){"use strict";var r=e(3),o=Object.keys;t.exports=function(t){return o(r(t)?Object(t):t)}},function(t,n,e){"use strict";t.exports=function(){}},function(t,n,e){"use strict";var r=e(3);t.exports=function(t){if(!r(t))throw new TypeError("Cannot use null or undefined");return t}},function(t,n,e){"use strict";var r=e(3),o=Array.prototype.forEach,i=Object.create;t.exports=function(t){var n=i(null);return o.call(arguments,function(t){r(t)&&function(t,n){var e;for(e in t)n[e]=t[e]}(Object(t),n)}),n}},function(t,n,e){"use strict";t.exports=function(t){return"function"==typeof t}},function(t,n,e){"use strict";t.exports=e(19)()?String.prototype.contains:e(20)},function(t,n,e){"use strict";var r="razdwatrzy";t.exports=function(){return"function"==typeof r.contains&&(!0===r.contains("dwa")&&!1===r.contains("foo"))}},function(t,n,e){"use strict";var r=String.prototype.indexOf;t.exports=function(t){return r.call(this,t,arguments[1])>-1}},function(t,n,e){"use strict";t.exports=function(t){if("function"!=typeof t)throw new TypeError(t+" is not a function");return t}},function(t,n){t.exports=function(t){return function n(e){return 0===arguments.length?n:null!=e&&!0===e["@@functional/placeholder"]?n:t.apply(this,arguments)}}},function(t,n,e){var r=e(24),o=e(25),i=e(26);t.exports=function(t,n,e){return function(){var a=arguments.length;if(0===a)return e();var u=arguments[a-1];if(!r(u)){var c=i(arguments,0,a-1);if("function"==typeof u[t])return u[t].apply(u,c);if(o(u))return n.apply(null,c)(u)}return e.apply(this,arguments)}}},function(t,n){t.exports=Array.isArray||function(t){return null!=t&&t.length>=0&&"[object Array]"===Object.prototype.toString.call(t)}},function(t,n){t.exports=function(t){return"function"==typeof t["@@transducer/step"]}},function(t,n){t.exports=function t(n,e,r){switch(arguments.length){case 1:return t(n,0,n.length);case 2:return t(n,e,n.length);default:for(var o=[],i=0,a=Math.max(0,Math.min(n.length,r)-e);i<a;)o[i]=n[e+i],i+=1;return o}}},function(t,n,e){var r=e(4),o=e(28),i=e(29);t.exports=function(){function t(t,n){this.xf=n,this.f=t,this.idx=-1,this.found=!1}return t.prototype["@@transducer/init"]=i.init,t.prototype["@@transducer/result"]=function(t){return this.found||(t=this.xf["@@transducer/step"](t,-1)),this.xf["@@transducer/result"](t)},t.prototype["@@transducer/step"]=function(t,n){return this.idx+=1,this.f(n)&&(this.found=!0,t=o(this.xf["@@transducer/step"](t,this.idx))),t},r(function(n,e){return new t(n,e)})}()},function(t,n){t.exports=function(t){return t&&t["@@transducer/reduced"]?t:{"@@transducer/value":t,"@@transducer/reduced":!0}}},function(t,n){t.exports={init:function(){return this.xf["@@transducer/init"]()},result:function(t){return this.xf["@@transducer/result"](t)}}},,function(t,n,e){"use strict";e.r(n);var r=e(0);const o=window.require("nw.gui"),i=window.require("path"),a=window.require("os");if(!Utils.isNwjs())throw"rmmv-mrp-core/map-exporter can only be run during development";const u=window.require("nw.gui"),c=window.require("fs"),l=window.require("path");function f(){const t=l.join(function(){const t=o.App.fullArgv.map(t=>t.match(/file:\/\/.*/))[0],n="win32"===a.platform()?8:7;return t?i.dirname(decodeURI(t[0].slice(n))):null}()||window.process.env.HOME||window.process.env.USERPROFILE,"MapExporter");try{c.mkdirSync(t)}catch(t){}return t}function s(t,n){return l.join(f(),function(t,n){return t||(t=$dataMapInfos[$gameMap._mapId].name),`${(new Date).toISOString().replace(/:/g,"-")} ${t=t.replace(/[^a-zA-Z0-9\s]/g,"")} ${n}.png`}(t,n))}function p(t,n,e,o,i){const a=(t+n)*r.a.SCREEN_WIDTH_TILES,u=(e+o)*r.a.SCREEN_HEIGHT_TILES,c=n*r.a.SCREEN_WIDTH_PX,l=o*r.a.SCREEN_HEIGHT_PX;$gameMap._displayX=a,$gameMap._displayY=u,SceneManager.updateScene(),SceneManager.renderScene();var f=SceneManager.snap()._canvas;i.getContext("2d").drawImage(f,c,l)}function _(t,n,e,r){var o=Math.ceil(r/e);if((t=Math.min(t,o))>=(n=Math.min(n,o)))throw`tried to compute a width or height of size 0: ${JSON.stringify([].slice.apply(arguments))}`;if(n===o)var i=(n-t-1)*e+(r%e||e);else i=(n-t)*e;return i}function d(t,n,e,o,i,a){t=Math.min(t,r.a.MAP_WIDTH_PAGES),n=Math.min(n,r.a.MAP_WIDTH_PAGES),e=Math.min(e,r.a.MAP_HEIGHT_PAGES),o=Math.min(o,r.a.MAP_HEIGHT_PAGES);const u=_(t,n,r.a.SCREEN_WIDTH_PX,r.a.MAP_WIDTH_PX),l=_(e,o,r.a.SCREEN_HEIGHT_PX,r.a.MAP_HEIGHT_PX),f=$gameMap._displayX,d=$gameMap._displayY,h=document.createElement("canvas");h.width=u,h.height=l;const E=$gamePlayer._opacity;var g,I;for($gamePlayer._opacity=0,g=t;g<n;g++)for(I=e;I<o;I++)p(t,g-t,e,I-e,h);$gamePlayer._opacity=E;const y=h.toDataURL().replace(/^data:image\/(png|jpg|jpeg);base64,/,"");c.writeFileSync(s(i,a),y,"base64"),$gameMap._displayY=d,$gameMap._displayX=f}window.MRP||(window.MRP={}),window.MRP.MapExporter=function({pagesPerImage:t=16,basename:n=null}={}){if(t<=0)throw"pagesPerImage must be > 0";requestAnimationFrame(function(){!function(t,n){var e=0,o=0,i=0,a=0;do{i=0,a=0;do{d(e,e+t,i,i+t,n,`${o}${a}`),i+=t,a++}while(i+t<=r.a.MAP_HEIGHT_PAGES);e+=t,o++}while(e+t<=r.a.MAP_WIDTH_PAGES)}(t,n),u.Shell.openItem(f())})}}]);